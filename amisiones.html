<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista del Docente - Gesti√≥n de Misiones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .mission-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .mission-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .mission-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .mission-header:hover {
            background: #5a67d8;
        }

        .mission-header h3 {
            font-size: 1.2rem;
        }

        .mission-points {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .mission-content {
            display: none;
            padding: 20px;
            background: white;
        }

        .mission-content.active {
            display: block;
        }

        .mission-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .students-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .student-card {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s ease;
        }

        .student-card:hover {
            background: #eeeeee;
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .student-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .student-response {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 8px;
            color: #666;
            font-style: italic;
            max-width: 300px;
            word-wrap: break-word;
        }

        .student-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            transform: scale(1.5);
            cursor: pointer;
        }

        .checkbox-container label {
            font-weight: 500;
            color: #4caf50;
            cursor: pointer;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-assign {
            background: #4caf50;
            color: white;
            margin-bottom: 20px;
        }

        .btn-assign:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76,175,80,0.4);
        }

        .btn-finish {
            background: #f44336;
            color: white;
            display: block;
            margin: 30px auto 0;
            font-size: 1.1rem;
            padding: 15px 40px;
        }

        .btn-finish:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244,67,54,0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }

        .no-missions {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
            font-size: 1.1rem;
        }

        .mission-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .type-normal { background: #e8f5e8; color: #2e7d32; }
        .type-question { background: #fff3e0; color: #f57c00; }
        .type-multiple-choice { background: #f3e5f5; color: #7b1fa2; }

        @media (max-width: 768px) {
            .student-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .student-actions {
                justify-content: center;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Gesti√≥n de Misiones</h1>

        <!-- Misiones Actuales -->
        <div class="section">
            <h2>üìã Misiones Actuales</h2>
            <div id="current-missions">
                <div class="loading">Cargando misiones actuales...</div>
            </div>
            <button id="finish-missions-btn" class="btn btn-finish" style="display: none;">
                üèÅ Finalizar Todas las Misiones
            </button>
        </div>

        <!-- Misiones Nuevas -->
        <div class="section">
            <h2>üÜï Misiones Nuevas Sin Asignar</h2>
            <div id="new-missions">
                <div class="loading">Cargando misiones nuevas...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuFtWGdyj-h8LtNLMyQruEdhWNC76kouE",
            authDomain: "puntos-de-merito.firebaseapp.com",
            projectId: "puntos-de-merito",
            storageBucket: "puntos-de-merito.firebasestorage.app",
            messagingSenderId: "793336144671",
            appId: "1:793336144671:web:a7a31c5cb6cd4e5474862a",
            measurementId: "G-CZ340GE3T7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let students = [];
        let allMissions = [];
        let currentMissions = [];
        let newMissions = [];

        // Cargar estudiantes
        async function loadStudents() {
            try {
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                students = studentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Estudiantes cargados:', students);
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
            }
        }

        // Cargar misiones desde daily_missions
        async function loadMissions() {
            try {
                const dailyMissionsSnapshot = await getDocs(collection(db, 'daily_missions'));
                allMissions = [];
                
                dailyMissionsSnapshot.docs.forEach(doc => {
                    const docData = doc.data();
                    if (docData.missions && Array.isArray(docData.missions)) {
                        docData.missions.forEach((mission, index) => {
                            allMissions.push({
                                ...mission,
                                docId: doc.id, // ID del documento daily_missions
                                missionIndex: index, // √çndice de la misi√≥n en el array
                                batchDate: docData.date
                            });
                        });
                    }
                });

                // Separar misiones asignadas y no asignadas
                currentMissions = allMissions.filter(mission => mission.assigned === true);
                newMissions = allMissions.filter(mission => mission.assigned !== true);

                console.log('Misiones cargadas:', allMissions);
                console.log('Misiones actuales:', currentMissions);
                console.log('Misiones nuevas:', newMissions);

                renderCurrentMissions();
                renderNewMissions();
            } catch (error) {
                console.error('Error cargando misiones:', error);
                document.getElementById('current-missions').innerHTML = '<div class="no-missions">Error al cargar las misiones</div>';
                document.getElementById('new-missions').innerHTML = '<div class="no-missions">Error al cargar las misiones</div>';
            }
        }

        // Renderizar misiones actuales
        function renderCurrentMissions() {
            const container = document.getElementById('current-missions');
            const finishBtn = document.getElementById('finish-missions-btn');

            if (currentMissions.length === 0) {
                container.innerHTML = '<div class="no-missions">No hay misiones asignadas actualmente</div>';
                finishBtn.style.display = 'none';
                return;
            }

            finishBtn.style.display = 'block';
            container.innerHTML = '';

            currentMissions.forEach(mission => {
                const missionCard = createMissionCard(mission, true);
                container.appendChild(missionCard);
            });
        }

        // Renderizar misiones nuevas
        function renderNewMissions() {
            const container = document.getElementById('new-missions');

            if (newMissions.length === 0) {
                container.innerHTML = '<div class="no-missions">No hay misiones nuevas disponibles</div>';
                return;
            }

            container.innerHTML = '';

            // Bot√≥n para asignar todas las misiones
            const assignAllBtn = document.createElement('button');
            assignAllBtn.className = 'btn btn-assign';
            assignAllBtn.style.marginBottom = '20px';
            assignAllBtn.style.display = 'block';
            assignAllBtn.innerHTML = `üìù Asignar Todas las Misiones (${newMissions.length})`;
            assignAllBtn.onclick = assignAllMissions;
            container.appendChild(assignAllBtn);

            newMissions.forEach(mission => {
                const missionCard = createMissionCard(mission, false);
                container.appendChild(missionCard);
            });
        }

        // Crear tarjeta de misi√≥n
        function createMissionCard(mission, isAssigned) {
            const card = document.createElement('div');
            card.className = 'mission-card';

            const typeClass = mission.type === 'normal' ? 'type-normal' : 
                             mission.type === 'question' ? 'type-question' : 'type-multiple-choice';
            const typeText = mission.type === 'normal' ? 'Normal' : 
                            mission.type === 'question' ? 'Pregunta' : 'Opci√≥n M√∫ltiple';

            card.innerHTML = `
                <div class="mission-header" onclick="toggleMission('${mission.id}')">
                    <div>
                        <h3>${mission.name}</h3>
                        <span class="mission-type ${typeClass}">${typeText}</span>
                    </div>
                    <div class="mission-points">${mission.points} pts</div>
                </div>
                <div class="mission-content" id="content-${mission.id}">
                    <div class="mission-info">
                        <p><strong>Descripci√≥n:</strong> ${mission.description}</p>
                        ${mission.question ? `<p><strong>Pregunta:</strong> ${mission.question}</p>` : ''}
                        ${mission.options ? `<p><strong>Opciones:</strong> A) ${mission.options.a}, B) ${mission.options.b}, C) ${mission.options.c}, D) ${mission.options.d}</p>` : ''}
                    </div>
                    ${isAssigned ? createStudentsGrid(mission) : ''}
                </div>
            `;

            return card;
        }

        // Crear grid de estudiantes
        function createStudentsGrid(mission) {
            let studentsHtml = '<div class="students-grid">';

            students.forEach(student => {
                const studentResponse = mission.responses && mission.responses[student.id] ? mission.responses[student.id] : null;
                const isCompleted = mission.completed && mission.completed.includes(student.id);

                studentsHtml += `
                    <div class="student-card">
                        <div class="student-info">
                            <div class="student-name">üë§ ${student.name}</div>
                            ${createResponseField(mission, student.id, studentResponse)}
                        </div>
                        <div class="student-actions">
                            <div class="checkbox-container">
                                <input type="checkbox" 
                                       id="check-${mission.id}-${student.id}" 
                                       ${isCompleted ? 'checked' : ''}
                                       onchange="toggleStudentCompletion('${mission.docId}', ${mission.missionIndex}, '${student.id}', ${mission.points})">
                                <label for="check-${mission.id}-${student.id}">Completado</label>
                            </div>
                        </div>
                    </div>
                `;
            });

            studentsHtml += '</div>';
            return studentsHtml;
        }

        // Crear campo de respuesta seg√∫n el tipo de misi√≥n
        function createResponseField(mission, studentId, response) {
            if (mission.type === 'normal') {
                return '';
            }

            if (mission.type === 'question') {
                return `<div class="student-response">
                    ${response ? `Respuesta: "${response}"` : 'Sin respuesta a√∫n'}
                </div>`;
            }

            if (mission.type === 'multiple-choice') {
                return `<div class="student-response">
                    ${response ? `Opci√≥n seleccionada: ${response}` : 'Sin selecci√≥n a√∫n'}
                </div>`;
            }

            return '';
        }

        // Toggle misi√≥n desplegable
        window.toggleMission = function(missionId) {
            const content = document.getElementById(`content-${missionId}`);
            content.classList.toggle('active');
        }

        // Asignar todas las misiones nuevas
        window.assignAllMissions = async function() {
            if (newMissions.length === 0) {
                alert('No hay misiones nuevas para asignar');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de que quieres asignar todas las ${newMissions.length} misiones nuevas?`)) {
                return;
            }

            try {
                // Agrupar misiones por documento
                const docGroups = {};
                newMissions.forEach(mission => {
                    if (!docGroups[mission.docId]) {
                        docGroups[mission.docId] = [];
                    }
                    docGroups[mission.docId].push(mission);
                });

                // Actualizar cada documento
                const updatePromises = Object.keys(docGroups).map(async (docId) => {
                    const docRef = doc(db, 'daily_missions', docId);
                    const docSnapshot = await getDocs(collection(db, 'daily_missions'));
                    
                    // Buscar el documento espec√≠fico
                    const targetDoc = docSnapshot.docs.find(d => d.id === docId);
                    if (targetDoc) {
                        const docData = targetDoc.data();
                        const missions = docData.missions;
                        
                        // Actualizar todas las misiones de este documento que est√°n en newMissions
                        docGroups[docId].forEach(newMission => {
                            const missionInDoc = missions.find(m => m.id === newMission.id);
                            if (missionInDoc) {
                                missionInDoc.assigned = true;
                                missionInDoc.assignedAt = new Date().toISOString();
                            }
                        });
                        
                        // Actualizar en Firebase
                        await updateDoc(docRef, { missions: missions });
                    }
                });

                await Promise.all(updatePromises);
                
                // Recargar misiones
                await loadMissions();
                alert(`¬°${newMissions.length} misiones asignadas correctamente!`);
                
            } catch (error) {
                console.error('Error asignando misiones:', error);
                alert('Error al asignar las misiones: ' + error.message);
            }
        }

        // Toggle completado del estudiante
        window.toggleStudentCompletion = async function(docId, missionIndex, studentId, points) {
            try {
                const docRef = doc(db, 'daily_missions', docId);
                
                // Obtener el documento actual
                const dailyMissionsSnapshot = await getDocs(collection(db, 'daily_missions'));
                const targetDoc = dailyMissionsSnapshot.docs.find(d => d.id === docId);
                
                if (targetDoc) {
                    const docData = targetDoc.data();
                    const missions = docData.missions;
                    const mission = missions[missionIndex];
                    
                    let completed = mission.completed || [];
                    
                    if (completed.includes(studentId)) {
                        // Remover de completados y quitar puntos
                        completed = completed.filter(id => id !== studentId);
                        await updateStudentPoints(studentId, -points);
                    } else {
                        // Agregar a completados y dar puntos
                        completed.push(studentId);
                        await updateStudentPoints(studentId, points);
                    }

                    // Actualizar la misi√≥n
                    missions[missionIndex].completed = completed;
                    
                    // Guardar en Firebase
                    await updateDoc(docRef, { missions: missions });
                    
                    // Actualizar en memoria
                    const missionInMemory = currentMissions.find(m => m.docId === docId && m.missionIndex === missionIndex);
                    if (missionInMemory) {
                        missionInMemory.completed = completed;
                    }
                }
            } catch (error) {
                console.error('Error actualizando completado:', error);
                alert('Error al actualizar el estado');
            }
        }

        // Actualizar puntos del estudiante
        async function updateStudentPoints(studentId, pointsToAdd) {
            try {
                const studentRef = doc(db, 'students', studentId);
                const student = students.find(s => s.id === studentId);
                const currentPoints = student.points || 0;
                
                await updateDoc(studentRef, {
                    points: currentPoints + pointsToAdd
                });

                // Actualizar en memoria
                student.points = currentPoints + pointsToAdd;
            } catch (error) {
                console.error('Error actualizando puntos:', error);
            }
        }

        // Finalizar todas las misiones
        document.getElementById('finish-missions-btn').addEventListener('click', async function() {
            if (!confirm('¬øEst√°s seguro de que quieres finalizar todas las misiones actuales? Esta acci√≥n eliminar√° las misiones pero mantendr√° los puntos de los estudiantes.')) {
                return;
            }

            try {
                // Agrupar misiones por documento
                const docGroups = {};
                currentMissions.forEach(mission => {
                    if (!docGroups[mission.docId]) {
                        docGroups[mission.docId] = [];
                    }
                    docGroups[mission.docId].push(mission);
                });

                // Eliminar cada documento de daily_missions que tiene misiones asignadas
                const deletePromises = Object.keys(docGroups).map(docId => 
                    deleteDoc(doc(db, 'daily_missions', docId))
                );
                
                await Promise.all(deletePromises);
                
                // Recargar misiones
                await loadMissions();
                
                alert('¬°Todas las misiones han sido finalizadas correctamente!');
            } catch (error) {
                console.error('Error finalizando misiones:', error);
                alert('Error al finalizar las misiones');
            }
        });

        // Inicializar la aplicaci√≥n
        async function init() {
            await loadStudents();
            await loadMissions();
        }

        init();
    </script>
</body>
</html>
