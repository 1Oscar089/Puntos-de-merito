<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Misiones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .mission-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .mission-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .mission-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-info h3 {
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .mission-info p {
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .points {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .question {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .options {
            margin: 10px 0;
        }

        .option {
            background: #f5f5f5;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #ddd;
        }

        .correct-option {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }

        .students-list {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .grade-section {
            margin-bottom: 25px;
        }

        .grade-title {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .student-response {
            flex-grow: 1;
            margin: 0 15px;
        }

        .response-text {
            font-style: italic;
            color: #6c757d;
        }

        .correct-indicator {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .correct {
            color: #28a745;
        }

        .incorrect {
            color: #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-complete {
            background: #28a745;
            color: white;
        }

        .btn-complete:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-assign {
            background: #007bff;
            color: white;
            font-size: 1.1rem;
            padding: 15px 30px;
            margin-top: 20px;
            width: 100%;
        }

        .btn-assign:hover {
            background: #0056b3;
        }

        .btn-finish {
            background: #dc3545;
            color: white;
            font-size: 1.1rem;
            padding: 15px 30px;
            margin-top: 20px;
            width: 100%;
        }

        .btn-finish:hover {
            background: #c82333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .expanded .expand-icon {
            transform: rotate(180deg);
        }

        .no-missions {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Gestor de Misiones</h1>
        
        <!-- Secci√≥n de Misiones Asignadas -->
        <div class="section">
            <h2 class="section-title">üìã Misiones Asignadas</h2>
            <div id="assigned-missions" class="loading">
                <div class="spinner"></div>
                <p>Cargando misiones asignadas...</p>
            </div>
            <button id="finish-missions" class="btn btn-finish" style="display: none;">
                üèÅ Terminar Misiones
            </button>
        </div>

        <!-- Secci√≥n de Misiones Nuevas -->
        <div class="section">
            <h2 class="section-title">‚ú® Misiones Nuevas</h2>
            <div id="new-missions" class="loading">
                <div class="spinner"></div>
                <p>Cargando misiones disponibles...</p>
            </div>
            <button id="assign-missions" class="btn btn-assign" style="display: none;">
                üì§ Asignar Misiones
            </button>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuFtWGdyj-h8LtNLMyQruEdhWNC76kouE",
            authDomain: "puntos-de-merito.firebaseapp.com",
            projectId: "puntos-de-merito",
            storageBucket: "puntos-de-merito.firebasestorage.app",
            messagingSenderId: "793336144671",
            appId: "1:793336144671:web:a7a31c5cb6cd4e5474862a",
            measurementId: "G-CZ340GE3T7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let assignedMissions = [];
        let newMissions = [];
        let missionResponses = [];
        let students = [];

        // Datos de ejemplo para estudiantes (organizar por grados)
        const sampleStudents = {
            "7mo": ["Ana Garc√≠a", "Carlos L√≥pez", "Mar√≠a Rodr√≠guez", "Jos√© Mart√≠nez"],
            "8vo": ["Sofia Hern√°ndez", "Diego P√©rez", "Lucia Gonz√°lez", "Miguel Torres"],
            "9no": ["Isabel Vargas", "Roberto Silva", "Carmen Flores", "Fernando Castro"]
        };

        // Cargar datos iniciales
        async function loadData() {
            try {
                // Cargar misiones asignadas desde Firebase
                const assignedMissionsSnapshot = await getDocs(collection(db, 'assigned_missions'));
                assignedMissions = [];
                assignedMissionsSnapshot.forEach((doc) => {
                    assignedMissions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Cargar misiones nuevas desde Firebase
                const newMissionsSnapshot = await getDocs(collection(db, 'missions'));
                newMissions = [];
                newMissionsSnapshot.forEach((doc) => {
                    newMissions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Cargar respuestas de misiones desde Firebase
                const responsesSnapshot = await getDocs(collection(db, 'mission_responses'));
                missionResponses = [];
                responsesSnapshot.forEach((doc) => {
                    missionResponses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Cargar estudiantes desde Firebase
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                students = {};
                studentsSnapshot.forEach((doc) => {
                    const studentData = doc.data();
                    const grade = studentData.grade || studentData.grado; // Flexible para diferentes nombres de campo
                    const name = studentData.name || studentData.nombre || studentData.fullName;
                    
                    if (!students[grade]) {
                        students[grade] = [];
                    }
                    students[grade].push(name);
                });

                // Si no hay estudiantes en Firebase, usar datos de ejemplo
                if (Object.keys(students).length === 0) {
                    students = {
                        "7mo": ["Ana Garc√≠a", "Carlos L√≥pez", "Mar√≠a Rodr√≠guez", "Jos√© Mart√≠nez"],
                        "8vo": ["Sofia Hern√°ndez", "Diego P√©rez", "Lucia Gonz√°lez", "Miguel Torres"],
                        "9no": ["Isabel Vargas", "Roberto Silva", "Carmen Flores", "Fernando Castro"]
                    };
                }

                renderAssignedMissions();
                renderNewMissions();
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('assigned-missions').innerHTML = '<div class="no-missions">‚ùå Error al cargar las misiones</div>';
                document.getElementById('new-missions').innerHTML = '<div class="no-missions">‚ùå Error al cargar las misiones</div>';
            }
        }

        function renderAssignedMissions() {
            const container = document.getElementById('assigned-missions');
            const finishBtn = document.getElementById('finish-missions');

            if (assignedMissions.length === 0) {
                container.innerHTML = '<div class="no-missions">üì≠ No hay misiones asignadas</div>';
                finishBtn.style.display = 'none';
                return;
            }

            let html = '';
            assignedMissions.forEach(mission => {
                html += createMissionCard(mission, true);
            });

            container.innerHTML = html;
            finishBtn.style.display = 'block';
            attachEventListeners(true);
        }

        function renderNewMissions() {
            const container = document.getElementById('new-missions');
            const assignBtn = document.getElementById('assign-missions');

            if (newMissions.length === 0) {
                container.innerHTML = '<div class="no-missions">üì≠ No hay misiones nuevas disponibles</div>';
                assignBtn.style.display = 'none';
                return;
            }

            let html = '';
            newMissions.forEach(mission => {
                html += createMissionCard(mission, false);
            });

            container.innerHTML = html;
            assignBtn.style.display = 'block';
        }

        function createMissionCard(mission, isAssigned) {
            const pointsText = mission.pointType === 'game' 
                ? `${mission.points} puntos de juego` 
                : `${mission.points} puntos`;

            let html = `
                <div class="mission-card ${isAssigned ? 'assigned' : 'new'}" data-mission-id="${mission.id}">
                    <div class="mission-header" ${isAssigned ? `onclick="toggleStudentsList('${mission.id}')"` : ''}>
                        <div class="mission-info">
                            <h3>üéØ ${mission.name}</h3>
                            <p>${mission.description}</p>
                            <span class="points">‚≠ê ${pointsText}</span>
            `;

            if (mission.type === 'question') {
                html += `
                            <div class="question">
                                <strong>‚ùì Pregunta:</strong> ${mission.question}
                            </div>
                `;
            } else if (mission.type === 'multiple_choice') {
                html += `
                            <div class="question">
                                <strong>‚ùì Pregunta:</strong> ${mission.question}
                                <div class="options">
                `;
                mission.options.forEach((option, index) => {
                    const isCorrect = index === mission.correctAnswer;
                    html += `
                                    <div class="option ${isCorrect ? 'correct-option' : ''}">
                                        ${isCorrect ? '‚úÖ' : '‚ñ´Ô∏è'} ${option}
                                    </div>
                    `;
                });
                html += `
                                </div>
                            </div>
                `;
            }

            html += `
                        </div>
            `;

            if (isAssigned) {
                html += `<span class="expand-icon">üîΩ</span>`;
            }

            html += `
                    </div>
            `;

            if (isAssigned) {
                html += createStudentsList(mission);
            }

            html += `</div>`;
            return html;
        }

        function createStudentsList(mission) {
            let html = `<div class="students-list" id="students-${mission.id}">`;
            
            Object.keys(students).forEach(grade => {
                html += `
                    <div class="grade-section">
                        <div class="grade-title">üéì ${grade} Grado</div>
                `;
                
                students[grade].forEach(student => {
                    html += createStudentItem(mission, student, grade);
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            return html;
        }

        function createStudentItem(mission, student, grade) {
            let html = `
                <div class="student-item">
                    <span class="student-name">üë§ ${student}</span>
            `;

            if (mission.type === 'question') {
                const response = missionResponses.find(r => 
                    r.missionId === mission.id && r.student === student
                );
                if (response) {
                    html += `
                        <div class="student-response">
                            <span class="response-text">üí¨ "${response.response}"</span>
                        </div>
                    `;
                }
            } else if (mission.type === 'multiple_choice') {
                const response = missionResponses.find(r => 
                    r.missionId === mission.id && r.student === student
                );
                if (response) {
                    const isCorrect = response.response === mission.correctAnswer;
                    const selectedOption = mission.options[response.response];
                    html += `
                        <div class="student-response">
                            <span class="response-text">üí¨ "${selectedOption}"</span>
                            <span class="correct-indicator ${isCorrect ? 'correct' : 'incorrect'}">
                                ${isCorrect ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                    `;
                }
            }

            html += `
                    <button class="btn btn-complete" onclick="markAsComplete('${mission.id}', '${student}', ${mission.points}, '${mission.pointType}')">
                        ‚úÖ Completar
                    </button>
                </div>
            `;
            return html;
        }

        function toggleStudentsList(missionId) {
            const studentsList = document.getElementById(`students-${missionId}`);
            const missionCard = document.querySelector(`[data-mission-id="${missionId}"]`);
            
            if (studentsList.style.display === 'none' || studentsList.style.display === '') {
                studentsList.style.display = 'block';
                missionCard.classList.add('expanded');
            } else {
                studentsList.style.display = 'none';
                missionCard.classList.remove('expanded');
            }
        }

        function markAsComplete(missionId, student, points, pointType) {
            const pointsText = pointType === 'game' ? `${points} puntos de juego` : `${points} puntos`;
            
            if (confirm(`‚úÖ ¬øConfirmas completar la misi√≥n?\n\nEstudiante: ${student}\nPuntos a otorgar: ${pointsText}`)) {
                // Aqu√≠ implementar√≠as la l√≥gica para sumar puntos al estudiante en Firebase
                // Por ejemplo, actualizando una colecci√≥n 'students' o 'student_points'
                
                try {
                    // Ejemplo de c√≥mo podr√≠as guardar los puntos:
                    // await addDoc(collection(db, 'student_points'), {
                    //     student: student,
                    //     points: points,
                    //     pointType: pointType,
                    //     missionId: missionId,
                    //     completedAt: new Date(),
                    //     completedBy: 'teacher' // o el usuario actual
                    // });
                    
                    alert(`‚úÖ ¬°Completado!\n\nEstudiante: ${student}\nPuntos otorgados: ${pointsText}`);
                    console.log(`Sumando ${points} ${pointType} puntos a ${student} por misi√≥n ${missionId}`);
                } catch (error) {
                    console.error("Error marking as complete:", error);
                    alert('‚ùå Error al completar la misi√≥n');
                }
            }
        }

        function attachEventListeners(isAssigned) {
            // Los event listeners ya est√°n definidos inline en el HTML
        }

        // Event listeners para botones principales
        document.getElementById('finish-missions').addEventListener('click', async () => {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres terminar todas las misiones?\n\nEsto eliminar√° todas las misiones asignadas y respuestas.')) {
                try {
                    // Eliminar todos los documentos de assigned_missions
                    const assignedMissionsSnapshot = await getDocs(collection(db, 'assigned_missions'));
                    const deleteAssignedPromises = [];
                    assignedMissionsSnapshot.forEach((docSnapshot) => {
                        deleteAssignedPromises.push(deleteDoc(doc(db, 'assigned_missions', docSnapshot.id)));
                    });

                    // Eliminar todos los documentos de mission_responses
                    const responsesSnapshot = await getDocs(collection(db, 'mission_responses'));
                    const deleteResponsesPromises = [];
                    responsesSnapshot.forEach((docSnapshot) => {
                        deleteResponsesPromises.push(deleteDoc(doc(db, 'mission_responses', docSnapshot.id)));
                    });

                    // Esperar a que se eliminen todos los documentos
                    await Promise.all([...deleteAssignedPromises, ...deleteResponsesPromises]);

                    // Actualizar arrays locales
                    assignedMissions = [];
                    missionResponses = [];
                    renderAssignedMissions();
                    alert('‚úÖ ¬°Misiones terminadas correctamente!');
                } catch (error) {
                    console.error("Error finishing missions:", error);
                    alert('‚ùå Error al terminar las misiones');
                }
            }
        });

        document.getElementById('assign-missions').addEventListener('click', async () => {
            if (newMissions.length === 0) {
                alert('‚ö†Ô∏è No hay misiones nuevas para asignar');
                return;
            }

            if (confirm(`üì§ ¬øDeseas asignar ${newMissions.length} misiones nuevas?`)) {
                try {
                    // Transferir misiones de 'missions' a 'assigned_missions'
                    const addPromises = [];
                    const deletePromises = [];

                    for (const mission of newMissions) {
                        // Crear copia de la misi√≥n sin el ID (Firebase generar√° uno nuevo)
                        const { id, ...missionData } = mission;
                        
                        // Agregar a assigned_missions
                        addPromises.push(addDoc(collection(db, 'assigned_missions'), missionData));
                        
                        // Eliminar de missions
                        deletePromises.push(deleteDoc(doc(db, 'missions', id)));
                    }

                    // Ejecutar todas las operaciones
                    await Promise.all([...addPromises, ...deletePromises]);

                    // Recargar datos
                    await loadData();
                    alert('‚úÖ ¬°Misiones asignadas correctamente!');
                } catch (error) {
                    console.error("Error assigning missions:", error);
                    alert('‚ùå Error al asignar las misiones');
                }
            }
        });

        // Hacer funciones globales para uso en onclick
        window.toggleStudentsList = toggleStudentsList;
        window.markAsComplete = markAsComplete;

        // Cargar datos al iniciar
        loadData();
    </script>
</body>
</html>
