<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéüÔ∏è Loter√≠a - Panel Docente</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #d93025;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .countdown-banner {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #d93025;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #1a73e8;
            color: white;
        }

        .winner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #fff3cd;
            margin: 5px 0;
            border-radius: 6px;
        }

        .place {
            width: 30px;
            height: 30px;
            background: #ffc107;
            color: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .tickets-info {
            font-size: 0.9em;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .action-btn {
            display: block;
            width: 100%;
            background: #d93025;
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        .alert {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéüÔ∏è Loter√≠a - Panel Docente</h1>
        </div>

        <div class="content">
            <!-- Temporizador -->
            <div class="countdown-banner">
                Pr√≥xima rifa en: <span id="countdown">Cargando...</span>
            </div>

            <!-- Fondo com√∫n -->
            <div class="info-card">
                Fondo Com√∫n: <span id="commonFund">Cargando...</span> puntos
            </div>

            <!-- Premios -->
            <h3>üí∞ Premios</h3>
            <table id="prizesTable">
                <thead>
                    <tr>
                        <th>Lugar</th>
                        <th>Premio (puntos)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="2" class="no-data">Cargando...</td></tr>
                </tbody>
            </table>

            <!-- Ganadores anteriores -->
            <h3>üèÜ Ganadores Anteriores</h3>
            <div id="previousWinners">
                <p class="no-data">Cargando ganadores...</p>
            </div>

            <!-- Bot√≥n -->
            <button id="endLotteryBtn" class="action-btn" onclick="endLottery()">
                üé∞ Terminar Loter√≠a
            </button>

            <!-- Alertas -->
            <div id="alerts"></div>
        </div>
    </div>

    <!-- Firebase CDN (compatible y estable) -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

    <script>
        console.log("üîß Iniciando sistema de loter√≠a...");

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAuFtWGdyj-h8LtNLMyQruEdhWNC76kouE",
            authDomain: "puntos-de-merito.firebaseapp.com",
            projectId: "puntos-de-merito",
            storageBucket: "puntos-de-merito.firebasestorage.app",
            messagingSenderId: "793336144671",
            appId: "1:793336144671:web:a7a31c5cb6cd4e5474862a",
            measurementId: "G-CZ340GE3T7"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            console.log("‚úÖ Firebase inicializado");
            loadData(db);
            startCountdown();
        } catch (error) {
            console.error("‚ùå Error al inicializar Firebase:", error);
            document.getElementById('alerts').innerHTML = 
                `<div class="alert alert-error">Firebase no se pudo cargar: ${error.message}</div>`;
        }

        // Cargar datos iniciales
        async function loadData(db) {
            try {
                // Fondo com√∫n
                const settingsDoc = await db.collection('lottery_settings').doc('current').get();
                const commonFund = settingsDoc.exists ? (settingsDoc.data().commonFund || 20) : 20;
                document.getElementById('commonFund').textContent = commonFund;

                // Premios
                const prizes = {
                    1: Math.floor(commonFund * 0.35),
                    2: Math.floor(commonFund * 0.20),
                    3: Math.floor(commonFund * 0.15),
                    4: Math.floor(commonFund * 0.10),
                    5: Math.floor(commonFund * 0.05)
                };

                const prizesTable = document.getElementById('prizesTable').querySelector('tbody');
                prizesTable.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${i}¬∞ Lugar</td><td>${prizes[i]}</td>`;
                    prizesTable.appendChild(tr);
                }

                // Ganadores anteriores
                const winnersSnapshot = await db.collection('previous_winners').get();
                const winnersContainer = document.getElementById('previousWinners');
                winnersContainer.innerHTML = '';

                if (winnersSnapshot.empty) {
                    winnersContainer.innerHTML = '<p class="no-data">No hay ganadores a√∫n.</p>';
                } else {
                    const sorted = winnersSnapshot.docs
                        .map(d => d.data())
                        .sort((a, b) => a.place - b.place);

                    sorted.forEach(w => {
                        const div = document.createElement('div');
                        div.className = 'winner';
                        div.innerHTML = `
                            <div class="place">${w.place}</div>
                            <div><strong>${w.name}</strong> - ${w.points} puntos</div>
                            <div class="tickets-info">üéüÔ∏è ${w.tickets || '?'}</div>
                        `;
                        winnersContainer.appendChild(div);
                    });
                }

            } catch (error) {
                console.error("‚ùå Error al cargar datos:", error);
                document.getElementById('alerts').innerHTML += 
                    `<div class="alert alert-error">Error al cargar datos: ${error.message}</div>`;
            }
        }

        // Temporizador: viernes a las 12:00 PM
        function startCountdown() {
            const interval = setInterval(() => {
                const now = new Date();
                let target = new Date(now);
                target.setHours(12, 0, 0, 0);

                const day = now.getDay();
                const daysUntilFriday = (5 - day + 7) % 7;
                if (day === 5 && now.getHours() >= 12) {
                    target.setDate(now.getDate() + 7);
                } else {
                    target.setDate(now.getDate() + daysUntilFriday);
                }

                const diff = target - now;
                if (diff <= 0) {
                    clearInterval(interval);
                    location.reload();
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('countdown').textContent = 
                    `${days}d ${hours}h ${mins}m ${secs}s`;
            }, 1000);
        }

        // Terminar loter√≠a
        async function endLottery() {
            if (!confirm('¬øEst√°s seguro de terminar la loter√≠a y realizar el sorteo?')) return;

            const btn = document.getElementById('endLotteryBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Procesando...';

            try {
                const db = firebase.firestore();

                // 1. Leer tickets
                const ticketsSnapshot = await db.collection('tickets').get();
                if (ticketsSnapshot.size === 0) {
                    alert("No hay tickets para sortear.");
                    btn.disabled = false;
                    return;
                }

                const allTickets = ticketsSnapshot.docs.map(d => d.data().studentNie);
                const uniqueNIEs = [...new Set(allTickets)];

                // 2. Leer student_tickets (para historial)
                const studentTicketsSnapshot = await db.collection('student_tickets').get();
                const studentTicketsMap = {};
                studentTicketsSnapshot.forEach(doc => {
                    const data = doc.data();
                    studentTicketsMap[data.studentNie] = data.count || 0;
                });

                // 3. Leer nombres de estudiantes
                const studentsSnapshot = await db.collection('students').get();
                const studentsMap = {};
                studentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    studentsMap[data.nie] = { name: data.name, ref: doc.ref };
                });

                // 4. Fondo com√∫n
                const settingsDoc = await db.collection('lottery_settings').doc('current').get();
                const commonFund = settingsDoc.exists ? settingsDoc.data().commonFund || 20 : 20;

                // 5. Calcular premios (piso)
                const prizes = {
                    1: Math.floor(commonFund * 0.35),
                    2: Math.floor(commonFund * 0.20),
                    3: Math.floor(commonFund * 0.15),
                    4: Math.floor(commonFund * 0.10),
                    5: Math.floor(commonFund * 0.05)
                };

                const totalAwarded = Object.values(prizes).reduce((a, b) => a + b, 0);
                const unclaimedPoints = commonFund - totalAwarded;

                // 6. Seleccionar ganadores
                const numPrizes = Math.min(uniqueNIEs.length, 5);
                const winners = [];
                const selectedNIEs = new Set();

                for (let place = numPrizes; place >= 1; place--) {
                    let candidate;
                    do {
                        const i = Math.floor(Math.random() * allTickets.length);
                        candidate = allTickets[i];
                    } while (selectedNIEs.has(candidate));
                    selectedNIEs.add(candidate);

                    if (studentsMap[candidate]) {
                        winners.push({
                            place,
                            studentNie: candidate,
                            name: studentsMap[candidate].name,
                            points: prizes[place],
                            tickets: studentTicketsMap[candidate] || 0
                        });
                    }
                }

                // 7. Guardar en n_ticket_past
                const batch1 = db.batch();
                studentTicketsSnapshot.forEach(doc => {
                    batch1.set(db.collection('n_ticket_past').doc(), {
                        ...doc.data(),
                        rifaDate: new Date()
                    });
                });
                await batch1.commit();

                // 8. Borrar previous_winners
                const oldWinners = await db.collection('previous_winners').get();
                const batch2 = db.batch();
                oldWinners.docs.forEach(doc => batch2.delete(doc.ref));
                await batch2.commit();

                // 9. Guardar nuevos ganadores
                for (const w of winners) {
                    await db.collection('previous_winners').add({
                        ...w,
                        timestamp: new Date()
                    });

                    // Sumar puntos al estudiante
                    const studentRef = studentsMap[w.studentNie]?.ref;
                    if (studentRef) {
                        const snap = await studentRef.get();
                        const current = snap.exists() ? (snap.data().points || 0) : 0;
                        await studentRef.update({ points: current + w.points });
                    }
                }

                // 10. Nuevo fondo: 15% + no repartidos
                const newCommonFund = Math.floor(commonFund * 0.15) + unclaimedPoints;
                await db.collection('lottery_settings').doc('current').set({ commonFund: newCommonFund });

                // 11. Limpiar colecciones
                const batch3 = db.batch();
                ticketsSnapshot.docs.forEach(doc => batch3.delete(doc.ref));
                studentTicketsSnapshot.docs.forEach(doc => batch3.delete(doc.ref));
                await batch3.commit();

                // 12. √âxito
                alert(`‚úÖ Sorteo completado.\n${winners.length} ganadores.\nNuevo fondo: ${newCommonFund} puntos.`);
                location.reload();

            } catch (error) {
                console.error("‚ùå Error en sorteo:", error);
                document.getElementById('alerts').innerHTML += 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = "üé∞ Terminar Loter√≠a";
            }
        }
    </script>
</body>
</html>
